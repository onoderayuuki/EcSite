<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@8.0.2/konva.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
    />

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Rich text on Canvas Demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }

      #editor-container {
        height: 80px;
        width: 500px;
        background-color: cadetblue;
      }
    </style>
  </head>

  <body>
    <div id="editor-container">
      <span style="color: white">
        くれなゐの二尺伸びたる薔薇の芽の針やはらかに春雨のふる
      </span>
    </div>
    
    <button id="button">表示</button>
    <div id="container"></div>
      <form action="editsave.php" method="POST">
        <!-- <input type="submit" class="" value="表示" /> -->
      </form>
      <script>
          // quill:editor
          var quill = new Quill("#editor-container", {
              modules: {
                  toolbar: [
            [{ header: [1, 2, false] }],
            [{ font: [] }],
            ["bold", "italic", "underline"],
            //文字色
            [{ color: [] }, { background: [] }],
            ["image", "code-block"],
          ],
        },
        placeholder: "Compose an epic...",
        theme: "snow", // or 'bubble'
      });

      //Konva:canvas
    //   const WIDTH = window.innerWidth;
    //   const HEIGHT = window.innerHeight;
      const stage = new Konva.Stage({
        container: "container",
        width: 707,
        height: 500,
      });
      const layer = new Konva.Layer();
      stage.add(layer);

      //konva:text
      const TEXT_IMAGE = new Konva.Image({
        x: 10, //***
        y: 10, //***
        draggable: true,
        // stroke: "red",
        scaleX: 1 / window.devicePixelRatio,
        scaleY: 1 / window.devicePixelRatio,
      });

      //Back_Image
      function loadImages(sources, callback) {
        let images = {};
        let loadedImages = 0;
        let numImages = 0;
        for (var src in sources) {
          numImages++;
        }
        for (var src in sources) {
          images[src] = new Image();
          images[src].onload = function () {
            if (++loadedImages >= numImages) {
              callback(images);
            }
          };
          images[src].src = sources[src];
        }
      }

      function buildStage(images) {
        const BACK_IMAGE = new Konva.Image({
          image: images.back,
          x: 0,
          y: 0,
        });
        layer.add(BACK_IMAGE);
        layer.add(TEXT_IMAGE);
      }

      const sources = {
        back: "./images/sample.jpg", //***
      };

      loadImages(sources, buildStage);

      //html2canvas
      function renderText() {
        // convert DOM into image
        html2canvas(document.querySelector(".ql-editor"), {
          //***
          backgroundColor: "rgba(0,0,0,0.2)",
        }).then((canvas) => {
          // show it inside Konva.Image
          TEXT_IMAGE.image(canvas);
        });
      }

      // batch updates, so we don't render text too frequently
      var timeout = null;
      function requestTextUpdate() {
        if (timeout) {
          return;
        }
        timeout = setTimeout(function () {
          timeout = null;
          renderText();
        }, 500);
      }

      // render text on all changes
      quill.on("text-change", requestTextUpdate);
      // make initial rendering
      renderText();

      //for debug
      document.getElementById("button").onclick =  ()=> {
            // console.log(TEXT_IMAGE.getAttrs()["x"]);
            console.log(BACK_IMAGE.getsrc());
      };
    </script>
  </body>
</html>
